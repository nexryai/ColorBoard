package auth

import (
	"errors"
	"fmt"
	"testing"

	"github.com/golang-jwt/jwt/v5"
)

// 11c8b2df4c559d28c9de5d410141b30d9e2bce3b & d4269a1730e50719e6b1606e42c3ab32b1280449
const (
	expiredJWT = "eyJhbGciOiJSUzI1NiIsImtpZCI6ImQ0MjY5YTE3MzBlNTA3MTllNmIxNjA2ZTQyYzNhYjMyYjEyODA0NDkiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoibmV4cnlhaSIsInBpY3R1cmUiOiJodHRwczovL2xoMy5nb29nbGV1c2VyY29udGVudC5jb20vYS0vQUxWLVVqVUljWkg5NS1lZ1FiSlg0LXdhLUhPMU50ZVQzbUVSV21Rc0xpaW16dnJUT1h2N3RmWC0zRmRmdzNzRUpqQ3lCLUVvTDRRVFd0aXRCeDV0Qk05UEkyamlmc3NMZHdGemctbGNjc01sWXlJYWRMOERkRFlodEV6emJqNmpjSGQxR1N2R3FZajRCNDA2ZEpFdVgxNFlETUtFUFl1YW1uZFlyRy10dUR1WXo5WXJ6QlVvOWM2XzZNeXVEczh4amhWb0dsbVVMcVUtelNFUW5wTDlqVV9EVUhYQWR0UVlSZmNqTG40QUJpaXJvUnh5ek5IUDlOV01WSTNGOFdweG0xQjV5RF9wVjNGbVZnOEg3SzZicXE2dGFWejU0VHZOdnRvRXNTS0tnaWI0Y0FNOTdIeHVHbkVRLU5TUDVlQXlXS2FvRHZkX0lSRnNBLWlBcEN6VmdUWC1hWGthallPRzNRck9hLVEwVFBDZ25XUDNYcnFSRTM5MmU1cjNvWWdIamZweG9yYkZtNDFTbDQtOTY2ekdabkJtSFczTDhkX0ttMS0tQjlOeFc5NklVZHlDd1BILTl4V3ZTNkhoTjk5b0N2U19JaXdiOHRWODl1akIyLVBkLWtxZXpZcnR4NkFfZEVRMThudlRmWjg5bHlHdmhZdUFSbEdEdTQ3Tzl1RUVwTmlNNlUyRm5QUDVOOWZndlo3MFMwZWZVbnJaT1dUUWdFaXdOZlVtZDE2MzJENWNKYThNWWROT3prbEt5dVY0dmJfZXpva2V2WWxRN1pac25sMkp6dEtfbjdFcWFKemZlM2ZTdzRPWS16MVFVT3k5N2ZZRG1taWJTeTk2a3ZhdTl0dVFEYVJ3V1RaSFdCX0ZrZmFlQ196R0U4VmEyVkhyRnJMU1QxUElIX1UzVGpXXzdLSFNlLU9FWHlxQzNJS1J0RXhkMFA0TkRvTFZIYnR5SVBIYVp6SmtZVmxOLWtta0xzMk5iZ3hzNkMycGRQbXRCWGV2QWZPQkhsRFBmeDNDUXNTYzZIekhJNXRnQVpJZXNvaUlCSFQ4WFpaTGVSeVNVQzFyc09pV1IycF9uN2pySFNNYmhVd1N1X2FlVDZPell3YzBvY2s0U0gwdXVtb1RlY1JEUllramZmeThWb1dTRkJCTmxVS1dYOUgxeVhjeFF5TlJKX0NtaXpDNEhPd3otSlVoc3N3bXNNblltc1N6M1VOYVRHXzhwcUxSUEdwcTM0M1FyekJYdktPRUJzRS0yRUpNRXh1QndnOUplX0V5SHRLZFR3YTJmZnEzd0tnWEQtUnhSTVVyaTZkbUF3PXM5Ni1jIiwiaXNzIjoiaHR0cHM6Ly9zZWN1cmV0b2tlbi5nb29nbGUuY29tL2NvbG9yYm9hcmQtbGFiIiwiYXVkIjoiY29sb3Jib2FyZC1sYWIiLCJhdXRoX3RpbWUiOjE3MjQyODYzNTQsInVzZXJfaWQiOiJRa09Fck5qN0lNT2RSalRtbDBKc2xyVG9nZTEzIiwic3ViIjoiUWtPRXJOajdJTU9kUmpUbWwwSnNsclRvZ2UxMyIsImlhdCI6MTcyNDI4NjM1NCwiZXhwIjoxNzI0Mjg5OTU0LCJlbWFpbCI6Im5leHJ5YWlAc2RhMS5uZXQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiZmlyZWJhc2UiOnsiaWRlbnRpdGllcyI6eyJnb29nbGUuY29tIjpbIjEwMzE1OTY0MDE4NzcxMzI0MzcyMSJdLCJlbWFpbCI6WyJuZXhyeWFpQHNkYTEubmV0Il19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.dpuybEQD8HS6XqgWFLJChXadzsZJhmwamcA7D5qJBuXPGKKS2hAiS6CDSoY_4dOYc_xDaNYs7bIMSMA62hhlkQcLroj75FPFXz5KBIhlmg8FB5JTXEXNPvUgVlYzzmNO9-N_j8UEcI9iUSlSAGHR9Qr91D9X0RzFhjrs4bG7VT2AtGy1_RdIzAWS2nNN5nwSr6AHaTZDWW3k-v56rycAG2SvjP2PR3WPrhV5siWfMB9uiHTdJrDLSfsA2de-uAY3O6V8_soPJ_XJFEoT2_SD4eIsY1H5SXqz_VJH2iTIvEz_l7FRM6W3MAPk_bLLVY_jGMXl-uf9YJT54A4GnJFZvw"
	untrustedHS256JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJyX2NhIiwibmFtZSI6IlJvbWNhdCIsImlhdCI6MTUxNjIzOTAyMn0.WUJTtp8fa-iQtiUK5iHwQU6YZhJhz_uRkwR2nf11dPE"
	untrustedHS384JWT = "eyJhbGciOiJIUzM4NCIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJyX2NhIiwibmFtZSI6IlJvbWNhdCIsImlhdCI6MTUxNjIzOTAyMn0.pj_Se4l0TIHZMDhbJoLXeSM_0ZK1L0fTXnueX34eDNllGBQ-KzBrdda3-A10uG1T"
	untrustedHS512JWT = "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJyX2NhIiwibmFtZSI6IlJvbWNhdCIsImlhdCI6MTUxNjIzOTAyMn0.ClAHDmPBhTRzmJsTfHrCmpD2xrY0K53tICKsJlzyzcvj0jkEE04sXIm4RmD8YLVp1yAycL2zF32TsrdWcFN9-g"
	untrustedRS256JWT = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYW5vY2FtZXJhIiwibmFtZSI6Ik1hcmNoIDd0aC4iLCJpYXQiOjE1MTYyMzkwMjJ9.Fsb0P9aBYjSFLhZ0k58h04Jls7odowYMyNGmLZElV01wqaQFzM-B5X1lZS9JPqMPQCe9JE48fsh45CZ9CycM2IGX1OMvwCm0_pQzMUfIVaF5CmwKrrORRdv4E1f458EA7BzVKWyK5O6f2CgcvolZ-u3H-YwcV_eOOyFJ5XAWsBpDmn-Zrj4pWuG2si_yAxVe1LouWEg2rypVOQ4wdJBOGkGe9Sm7hAaFQFuzfK6KIE9r1nSp3QbrMjFbX9TYhBlY5ZoMxksN1mntu2CuSxCjOeWhQAHZDT5zaex2NS_D-R4Do36kS3YWrFsweI1oNP85-8v7otq49vwjQkzexh4a9Q"
	untrustedRS384JWT = "eyJhbGciOiJSUzM4NCIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0cmFzaGNhbiIsIm5hbWUiOiJTdGVsbGUiLCJpYXQiOjE1MTYyMzkwMjJ9.ot55_N9x95ypaQyEjrCYtDb7WGSzFpWSsJYA2GQWxkLykdbolelFFZZ4KTfCjDH1hgp6lb9l8ITIamcPGEvEtTPq2-JfSvUdVVcaxDEeUeNv-gz_ut-_aa38Qko49WVPLKR0K4qZxhAKlVqEcoHl4A4kCKsDgVdWdYcJrRxmXFfhrl6eAMoSrib5LXibWLEQep6PudxQm228wrCzP5teuZQGU6jOsgPO4QJd4pg66sFb4fFMAeXFANdYOx7UDxjzIRJOtnx-B7hGpVMAajt4XFtaqh2hG4tBzWF9ff0k3JQPMFiqezngybviYRQsE-zGDd1dzRiLPQamrBhw0sioJw"
	untrustedRS512JWT = "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhc3RhIiwibmFtZSI6IkFzdGEiLCJpYXQiOjE1MTYyMzkwMjJ9.ljzQIh_AXg5n4qVECS8Ed-soV283bcNuWd8lAfp9QnQ-gGbQbEOVOjYm1X0E1GHNse00tf-Nw-lChaCwWEcLU7Buh4mr8AzvO97m8uCqzUssyVefxw4MpyiLRzfuIT46cJNoj3ZVhdW2pmX1E42MNGdKGqLvdHXnTyLLahrbsUn-9eMSxw1KqfBzKFYyDcMd9eJX6aX7clZfdmj41WwYF20eTFDp76LEIYr7y-bI1D9hoKqrQ5jvX4yXMsTb-k_9CBWwC548wrLY2FiJMghfSI9D93pxA3bIwmiaWlVjDni0hdy9oUXYmAwYozihgalAGe0VGNMrZc8fUjx5lcfWHg"
	invalidHS256JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJzdGVzYW5fd2F2ZSIsIm5hbWUiOiJTdGVzYW4iLCJpYXQiOjE1MTYyMzkwMjIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.PVopw3jLaPd8wFWgLXupFtG-rLOMt2ULM4zfcSyr2tY"
	invalidHS384JWT = "eyJhbGciOiJIUzM4NCIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJ0cmFzaGNhbiIsIm5hbWUiOiJTdGVsbGUiLCJpYXQiOjE1MTYyMzkwMjIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.yCghXJVJ5VWfX9iZsyZ52gfsZmKBjbyO2K-u52sRTQldJmvtUvUCrmMewStpxU1x"
	invalidHS512JWT = "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJuYW5vIiwibmFtZSI6Ik1hcmNoIDd0aCIsImlhdCI6MTUxNjIzOTAyMiwia2lkIjoiMTFjOGIyZGY0YzU1OWQyOGM5ZGU1ZDQxMDE0MWIzMGQ5ZTJiY2UzYiJ9.nG56ZVTY2Y0pnTbCWFNZpVE1dw-x2vbu_Pd0_51uoauQe9PP-qmZecisveEzrM7DfqDGVVMvBKQqehjiJQo_-w"
	invalidRS256JWT = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJ5b3JoYV8yYiIsIm5hbWUiOiIyQiIsImlhdCI6MTUxNjIzOTAyMiwia2lkIjoiMTFjOGIyZGY0YzU1OWQyOGM5ZGU1ZDQxMDE0MWIzMGQ5ZTJiY2UzYiJ9.T0tGJpHZpOZ4-YNYNB8GIapH8_-DRbKBbTfQGMgBTG73t8uB4-5_jc5XCkketPXPEvjlSk_IuszaPvKmls74W94cxcU0RnU6easRoALxT6MhK1el-kxvYFGwwramLwM57M9cEMc4FSWLSo6vWixI_rjbVELkRqt1BS9Asz08bpaR-eHp26iSrq3qEEX6yj7-iHETqqVdkBxB4wMbu_64D9NWdc2tAqPJ_8C9gh2il6bvY-1YJn0FdyUe9curAAclAAFx9Di-YOzWTJ5ufFV5Y07CjGA26jCqP5_3dI2Rw1UGXUtpdfK755wzKLoC7apRUutRf_2XcsIUaGV0ZsHI7w"
	invalidRS384JWT = "eyJhbGciOiJSUzM4NCIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJ5b3JoYV85cyIsIm5hbWUiOiI5UyIsImlhdCI6MTUxNjIzOTAyMiwia2lkIjoiMTFjOGIyZGY0YzU1OWQyOGM5ZGU1ZDQxMDE0MWIzMGQ5ZTJiY2UzYiJ9.KzfLvp79ZZxQEnebjLzPKdb13sGLYNP71P9Ezkl-jinXo4irI4NJ1pxd8sPQZXP50PXx-4mzJyvIOQMsvnXtl44BL2LZRz9LbS4PuXHjfxLntkdQQEtDTTUlrKXx83-TSv0KDiV-NDObcDDXX4E_nD7hPS2skhA5BkNwISjk_tkLsXHDl9x--ixXP6VZKcYZuuExK5SLUlbYDnEbcKO62dqF2Qlb_M7BK0AvK-yfcAS0oQyfoabwWcMznzSVUPfnohDQGthRW5qjP0MSyTvlE79sCyz9RQhppAIjHp8YpiG2yT1Tdq8se_HNXaaAcHthwXLM1Czi2gRt_Z_iKNVtiQ"
	invalidRS512JWT = "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsImtpZCI6IjExYzhiMmRmNGM1NTlkMjhjOWRlNWQ0MTAxNDFiMzBkOWUyYmNlM2IifQ.eyJzdWIiOiJ5b3JoYV9hMiIsIm5hbWUiOiJBMiIsImlhdCI6MTUxNjIzOTAyMiwia2lkIjoiMTFjOGIyZGY0YzU1OWQyOGM5ZGU1ZDQxMDE0MWIzMGQ5ZTJiY2UzYiJ9.U1f46HtsXeU3FrAqlvtaZVxxXwxhc-P1J0-0PKwZssLurjE6Q5rLcZXDIZh5A6NQJYjRUkHPRz3nbrbep0hrjl9h9MLXTa6feH9KAf9uah16vyMcRV0XFp5-9lqZQ48ec_Ly5HBbgAc5ZkzYq1OVtMLUvs7gt7Q6HtM1bNBOGuhSgJPnIRDF4-HRG8tdPowS5WdzRoIHOSNQawOwBAbNvgOZvVxI1wIeoDgxAROUt4VgwY3xab4WkUFmusUaTjKp-6U_i9ta8PuQATnbJnEBsGf8xl9p513dpU-fsv6T5JR92p6vnaRO22Ae78Sk6JUonAt8XvEFsK4-VDBFK5S4iA"
)

func TestParseFirebaseJWT(t *testing.T) {
	t.Run("期限切れのトークンは弾かれる", func(t *testing.T) {
		claims, err := parseFirebaseJWT(expiredJWT)
		if !errors.Is(err, jwt.ErrTokenInvalidClaims) {
			t.Error("Expected error not returned: ", err)
		}

		if err.Error() != "token has invalid claims: token is expired" {
			t.Error("Expected error message not returned: ", err.Error())
		}
		
		if claims != nil {
			t.Error("Returned tesult value is not nil")
		}
	})

	t.Run("信頼されていない鍵で署名されたトークンは弾かれる", func(t *testing.T) {
		untrustedTokens := map[string]string{
			"HS256": untrustedHS256JWT,
			"HS384": untrustedHS384JWT,
			"HS512": untrustedHS512JWT,
			"RS256": untrustedRS256JWT,
			"RS384": untrustedRS384JWT,
			"RS512": untrustedRS512JWT,
		}

		for algo, v := range untrustedTokens {
			_, err := parseFirebaseJWT(v)
			if !errors.Is(err, ErrUntrustedKey) {
				t.Error(fmt.Errorf("Expected error not returned (%s): %s", algo, err))
			}
		}
	})

	t.Run("KIDが偽装されていても署名が不正なら弾かれる", func(t *testing.T) {
		untrustedTokens := map[string]string{
			"HS256": invalidHS256JWT,
			"HS384": invalidHS384JWT,
			"HS512": invalidHS512JWT,
			"RS256": invalidRS256JWT,
			"RS384": invalidRS384JWT,
			"RS512": invalidRS512JWT,
		}

		for algo, v := range untrustedTokens {
			claims, err := parseFirebaseJWT(v)
			if !errors.Is(err, jwt.ErrTokenSignatureInvalid) {
				t.Error(fmt.Errorf("Expected error not returned (%s): %s", algo, err))
			}

			if claims != nil {
				t.Error("Returned tesult value is not nil")
			}
		}
	})
}
